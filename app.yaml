# Databricks App Configuration
# WeCom Feedback Collection System

name: wecomfb
description: WeCom Feedback Collection System

command:
  - "bash"
  - "-c"
  - |
    set -e
    echo "Starting WeCom Feedback Collection System..."
    echo "Working directory: $(pwd)"
    ls -la
    
    # Set PYTHONPATH
    export PYTHONPATH="$(pwd):${PYTHONPATH:-}"
    echo "PYTHONPATH: ${PYTHONPATH}"
    
    # Install dependencies
    if [ -f "requirements.txt" ]; then
      echo "Installing dependencies..."
      pip install --quiet --no-cache-dir -r requirements.txt
    fi
    
    # Start gunicorn on port 8000 (avoid port 8080 conflicts with Databricks internal services)
    echo "Starting API service on port 8000..."
    exec gunicorn databricks_app.api_app:app \
      --bind 0.0.0.0:8000 \
      --workers 2 \
      --timeout 120 \
      --access-logfile - \
      --error-logfile -

env:
  - name: STORAGE_BACKEND
    value: "uc"
  - name: UC_CATALOG
    value: "dev"
  - name: UC_SCHEMA
    value: "inner_feedback"
  - name: TABLE_NAME
    value: "player_feedback"
  - name: LOCAL_STORAGE_PATH
    value: "./data"
  - name: DATABRICKS_HOST
    value: "{{secrets/feedback-scope/databricks-host}}"
  - name: DATABRICKS_TOKEN
    value: "{{secrets/feedback-scope/databricks-token}}"
  - name: WEBHOOK_SECRET
    value: "{{secrets/feedback-scope/webhook-secret}}"

resources:
  cpu: "2"
  memory: "4Gi"

health:
  path: "/health"
  port: 8000
  interval: 30
